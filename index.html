<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المستكشف الجغرافي - القريات</title>
    
    <!-- مكتبات الخرائط والتصميم -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Cairo', sans-serif; }
        #map { height: 100%; width: 100%; z-index: 0; }
        
        /* شاشة التحميل */
        #loading-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.98);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            transition: opacity 0.5s;
        }

        /* تحسين مظهر التمرير */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .leaflet-popup-content-wrapper { 
            border-radius: 8px; 
            padding: 0;
            overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .leaflet-popup-content { margin: 0; width: 300px !important; }
        
        /* تنبيهات */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            padding: 10px 20px;
            border-radius: 50px;
            background: rgba(0,0,0,0.8);
            color: white;
            font-size: 0.9rem;
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translate(-50%, 20px); } to { opacity: 1; transform: translate(-50%, 0); } }

        /* تأثيرات حركية لصفوف الفلتر */
        .filter-row {
            animation: slideIn 0.2s ease-out;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col md:flex-row overflow-hidden">

    <!-- شاشة التحميل -->
    <div id="loading-screen">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600 mb-4"></div>
        <h2 class="text-xl font-bold text-slate-700" id="loading-text">جاري الاتصال بقاعدة البيانات...</h2>
        <p class="text-sm text-slate-500 mt-2">يرجى الانتظار قليلاً</p>
    </div>

    <!-- رسالة تنبيه -->
    <div id="toast" class="toast flex items-center gap-2">
        <i class="fa-solid fa-circle-info text-yellow-400"></i>
        <span id="toast-msg"></span>
    </div>

    <!-- الشريط الجانبي -->
    <aside class="w-full md:w-96 bg-white shadow-2xl z-20 flex flex-col border-l border-gray-200">
        
        <!-- الترويسة -->
        <div class="bg-slate-800 text-white p-6 shadow-md">
            <div class="flex items-center gap-3 mb-2">
                <div class="bg-blue-600 p-2 rounded-lg"><i class="fa-solid fa-map-location-dot text-xl"></i></div>
                <div>
                    <h1 class="text-lg font-bold">بوابة البيانات المكانية</h1>
                    <p class="text-xs text-slate-400">نظام استعراض الأراضي - القريات</p>
                </div>
            </div>
        </div>

        <!-- المحتوى -->
        <div class="flex-1 overflow-y-auto p-4 space-y-6">

            <!-- رسالة حالة النظام -->
            <div id="system-msg" class="bg-blue-50 p-4 rounded-xl border border-blue-200 shadow-sm hidden">
                <h3 class="text-sm font-bold text-blue-800 mb-2 flex items-center gap-2">
                    <i class="fa-solid fa-info-circle"></i>
                    حالة النظام
                </h3>
                <p class="text-xs text-blue-600 mb-3 leading-relaxed" id="system-msg-text">
                    جاري التحقق...
                </p>
            </div>

            <!-- بطاقة الفلترة المتقدمة -->
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-5">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-slate-700 flex items-center gap-2">
                        <i class="fa-solid fa-filter text-blue-600"></i>
                        تصفية متقدمة
                    </h3>
                    <button id="addFilterBtn" class="text-xs bg-blue-50 text-blue-600 hover:bg-blue-100 px-3 py-1.5 rounded-full font-bold transition flex items-center gap-1 border border-blue-100">
                        <i class="fa-solid fa-plus"></i> إضافة معيار
                    </button>
                </div>

                <!-- حاوية الفلاتر -->
                <div id="filters-container" class="space-y-3">
                    <!-- سيتم إضافة صفوف الفلترة هنا ديناميكياً -->
                </div>

                <div class="mt-4 pt-3 border-t border-slate-100 flex justify-between items-center">
                    <div class="text-xs text-slate-500">
                        النتائج: <span id="countBadge" class="bg-blue-100 text-blue-800 font-bold px-2 py-0.5 rounded border border-blue-200 mx-1">0</span> أرض
                    </div>
                    <button id="resetBtn" class="text-xs text-slate-500 hover:text-red-600 underline transition">
                        مسح الكل
                    </button>
                </div>
            </div>

            <!-- التحكم بالطبقات -->
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-4">
                <h3 class="font-bold text-slate-700 mb-3 text-sm">الطبقات المتاحة</h3>
                <div class="space-y-2">
                    <!-- طبقة الأراضي -->
                    <label class="flex items-center justify-between p-3 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100 transition border border-transparent hover:border-slate-300 group">
                        <div class="flex items-center gap-3">
                            <input type="checkbox" checked onchange="toggleLayer('lands', this.checked)" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                            <span class="text-sm font-medium text-slate-700 group-hover:text-blue-700">الأراضي الحكومية (نقاط)</span>
                        </div>
                        <span class="w-3 h-3 rounded-full bg-blue-600 ring-2 ring-blue-200"></span>
                    </label>

                    <!-- طبقة النطاق العمراني -->
                    <label class="flex items-center justify-between p-3 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100 transition border border-transparent hover:border-slate-300 group">
                        <div class="flex items-center gap-3">
                            <input type="checkbox" checked onchange="toggleLayer('urban', this.checked)" class="w-4 h-4 text-orange-500 rounded focus:ring-orange-500">
                            <span class="text-sm font-medium text-slate-700 group-hover:text-orange-700">النطاق العمراني</span>
                        </div>
                        <span class="w-3 h-3 border-2 border-dashed border-orange-500"></span>
                    </label>

                    <!-- طبقة التنمية -->
                    <label class="flex items-center justify-between p-3 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100 transition border border-transparent hover:border-slate-300 group">
                        <div class="flex items-center gap-3">
                            <input type="checkbox" checked onchange="toggleLayer('dev', this.checked)" class="w-4 h-4 text-green-600 rounded focus:ring-green-500">
                            <span class="text-sm font-medium text-slate-700 group-hover:text-green-700">حدود التنمية</span>
                        </div>
                        <span class="w-3 h-3 border-2 border-green-600"></span>
                    </label>
                </div>
            </div>
            
             <!-- حالة البيانات -->
             <div id="data-status" class="p-3 bg-gray-100 rounded text-xs text-gray-500 text-center">
                جاري الاتصال...
            </div>
        </div>

        <div class="p-4 bg-slate-50 text-center text-[10px] text-slate-400 border-t">
            Saud Consult GIS Team &copy; 2024
        </div>
    </aside>

    <!-- الخريطة -->
    <main class="flex-1 relative">
        <div id="map"></div>
        
        <!-- زر الموقع الحالي -->
        <button onclick="map.locate({setView: true, maxZoom: 16})" class="absolute bottom-6 right-6 z-[1000] bg-white p-3 rounded-full shadow-lg text-slate-600 hover:text-blue-600 transition" title="موقعي">
            <i class="fa-solid fa-crosshairs text-lg"></i>
        </button>
    </main>

    <script>
        // ==========================================
        // 1. إعدادات البيانات
        // ==========================================
        const FILES = {
            lands: 'lands.geojson',   
            urban: 'urban.geojson',   
            dev: 'dev.geojson'        
        };

        let landsData = null; 
        let urbanData = null;
        let devData = null;

        // ==========================================
        // 2. إعداد الخريطة
        // ==========================================
        
        const map = L.map('map', {zoomControl: false}).setView([31.33, 37.34], 12);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            maxZoom: 19
        }).addTo(map);

        const layers = {
            lands: new L.LayerGroup().addTo(map),
            urban: new L.LayerGroup().addTo(map),
            dev: new L.LayerGroup().addTo(map)
        };

        const styles = {
            urban: { color: "#ea580c", weight: 2, dashArray: '8, 8', fill: false },
            dev:   { color: "#16a34a", weight: 3, fill: false }
        };

        // ==========================================
        // 3. المنطق الأساسي والتهيئة
        // ==========================================

        async function init() {
            try {
                const response = await fetch(FILES.lands);
                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                landsData = await response.json();
                
                showToast(`تم تحميل البيانات بنجاح`, "success");
                document.getElementById('data-status').innerHTML = '<span class="text-green-600 font-bold"><i class="fa-solid fa-check"></i> متصل بالخادم (Live)</span>';
                document.getElementById('system-msg').classList.add('hidden');

                try { const uRes = await fetch(FILES.urban); if(uRes.ok) urbanData = await uRes.json(); } catch(e) {}
                try { const dRes = await fetch(FILES.dev); if(dRes.ok) devData = await dRes.json(); } catch(e) {}

            } catch (error) {
                const errorText = error.message || "";
                const isPreviewError = errorText.includes("Failed to parse URL") || errorText.includes("NetworkError");
                const msgBox = document.getElementById('system-msg');
                const msgText = document.getElementById('system-msg-text');
                msgBox.classList.remove('hidden');

                if (isPreviewError) {
                    console.warn("وضع المعاينة: سيتم جلب البيانات عند الرفع.");
                    msgText.innerHTML = "<b>تنبيه المعاينة:</b> لا يمكن قراءة الملفات محلياً. ستعمل تلقائياً عند الرفع على GitHub.";
                    document.getElementById('data-status').innerHTML = '<span class="text-orange-500 font-bold"><i class="fa-solid fa-flask"></i> وضع المعاينة</span>';
                } else {
                    console.error("خطأ:", error);
                    msgText.innerHTML = `<span class="text-red-600 font-bold">خطأ:</span> لم يتم العثور على <b>lands.geojson</b>.`;
                    document.getElementById('data-status').innerHTML = '<span class="text-red-500 font-bold"><i class="fa-solid fa-xmark"></i> خطأ اتصال</span>';
                }
            } finally {
                renderLayers();
                
                // تهيئة الفلاتر
                if (landsData) {
                    addFilterRow();
                    updateCount(landsData.features.length);
                }
                
                document.getElementById('loading-screen').style.opacity = '0';
                setTimeout(() => { document.getElementById('loading-screen').style.display = 'none'; }, 500);
            }
        }

        // ==========================================
        // 4. منطق الفلترة المتقدمة (متعددة المعايير والرقمية)
        // ==========================================

        const filtersContainer = document.getElementById('filters-container');

        // إضافة صف فلتر جديد
        function addFilterRow() {
            if (!landsData || !landsData.features.length) return;

            const rowId = 'filter-row-' + Date.now();
            const row = document.createElement('div');
            row.className = 'filter-row flex gap-2 items-center bg-slate-50 p-2 rounded-lg border border-slate-200 flex-wrap';
            row.id = rowId;

            // بناء الصف الأساسي
            row.innerHTML = `
                <div class="w-full sm:w-1/3">
                    <select class="filter-attr w-full bg-white border border-slate-300 text-slate-700 text-xs rounded focus:ring-blue-500 focus:border-blue-500 p-2" onchange="handleAttrChange('${rowId}')">
                        <option value="">-- اختر الحقل --</option>
                    </select>
                </div>
                <div class="filter-values-container flex-1 flex gap-2">
                    <!-- سيتم تعبئة هذا الجزء ديناميكياً (قائمة أو حقول رقمية) -->
                    <select class="filter-val w-full bg-white border border-slate-300 text-slate-700 text-xs rounded focus:ring-blue-500 focus:border-blue-500 p-2 disabled:bg-slate-100" disabled>
                        <option value="">-- القيمة --</option>
                    </select>
                </div>
                <button onclick="removeFilterRow('${rowId}')" class="text-slate-400 hover:text-red-500 transition px-1" title="حذف">
                    <i class="fa-solid fa-times"></i>
                </button>
            `;

            filtersContainer.appendChild(row);
            populateAttributes(row.querySelector('.filter-attr'));
        }

        // حذف صف فلتر
        window.removeFilterRow = function(rowId) {
            const row = document.getElementById(rowId);
            if(row) {
                row.remove();
                applyMultiFilters(); 
            }
            if (filtersContainer.children.length === 0) addFilterRow();
        };

        // الأزرار
        document.getElementById('addFilterBtn').addEventListener('click', addFilterRow);
        document.getElementById('resetBtn').addEventListener('click', () => {
            filtersContainer.innerHTML = '';
            addFilterRow();
            applyMultiFilters();
        });

        // تعبئة الحقول
        function populateAttributes(selectElement) {
            const keys = Object.keys(landsData.features[0].properties);
            keys.sort().forEach(key => {
                 if(key !== 'OBJECTID' && key !== 'Shape' && key !== 'GlobalID' && key !== 'Shape_Length' && key !== 'Shape_Area' && key !== 'X' && key !== 'Y') {
                    const opt = document.createElement('option');
                    opt.value = key;
                    opt.innerText = key;
                    selectElement.appendChild(opt);
                 }
            });
        }

        // فحص هل الحقل رقمي (مثل المساحة)
        function isNumericField(attrName, sampleVal) {
            // تحقق من الاسم
            if (attrName.includes("المساحة") || attrName.includes("Area")) return true;
            // تحقق من القيمة
            return !isNaN(parseFloat(sampleVal)) && isFinite(sampleVal);
        }

        // معالجة تغيير الحقل المختار
        window.handleAttrChange = function(rowId) {
            const row = document.getElementById(rowId);
            const attrSelect = row.querySelector('.filter-attr');
            const container = row.querySelector('.filter-values-container');
            const attr = attrSelect.value;

            if (!attr) {
                container.innerHTML = `<select class="filter-val w-full bg-white border border-slate-300 text-slate-700 text-xs rounded p-2" disabled><option>-- القيمة --</option></select>`;
                applyMultiFilters();
                return;
            }

            // فحص نوع البيانات (من أول عنصر يحتوي على هذا الحقل)
            const sampleFeature = landsData.features.find(f => f.properties[attr] != null);
            const isNumeric = sampleFeature && isNumericField(attr, sampleFeature.properties[attr]);

            if (isNumeric) {
                // وضع الواجهة الرقمية (مشغل + مدخلات)
                container.innerHTML = `
                    <select class="filter-op w-1/3 bg-white border border-slate-300 text-slate-700 text-xs rounded focus:ring-blue-500 p-2" onchange="handleOpChange('${rowId}')">
                        <option value="eq">يساوي (=)</option>
                        <option value="gt">أكبر من (>)</option>
                        <option value="lt">أصغر من (<)</option>
                        <option value="bt">بين قيمتين (..)</option>
                    </select>
                    <input type="number" class="filter-num-1 flex-1 bg-white border border-slate-300 text-slate-700 text-xs rounded focus:ring-blue-500 p-2" placeholder="القيمة" oninput="applyMultiFilters()">
                    <input type="number" class="filter-num-2 flex-1 bg-white border border-slate-300 text-slate-700 text-xs rounded focus:ring-blue-500 p-2 hidden" placeholder="إلى" oninput="applyMultiFilters()">
                `;
            } else {
                // وضع القائمة النصية العادية
                container.innerHTML = `
                    <select class="filter-val w-full bg-white border border-slate-300 text-slate-700 text-xs rounded focus:ring-blue-500 p-2" onchange="applyMultiFilters()">
                        <option value="">-- الكل --</option>
                    </select>
                `;
                
                // تعبئة القيم الفريدة
                const valSelect = container.querySelector('.filter-val');
                const uniqueValues = new Set();
                landsData.features.forEach(f => {
                    if (f.properties[attr] != null) uniqueValues.add(f.properties[attr]);
                });
                
                const sortedValues = Array.from(uniqueValues).sort();
                sortedValues.forEach(val => {
                    const opt = document.createElement('option');
                    opt.value = val;
                    opt.innerText = val;
                    valSelect.appendChild(opt);
                });
            }
            applyMultiFilters();
        };

        // معالجة تغيير المشغل الرقمي (إظهار حقل "إلى" عند اختيار "بين")
        window.handleOpChange = function(rowId) {
            const row = document.getElementById(rowId);
            const op = row.querySelector('.filter-op').value;
            const input2 = row.querySelector('.filter-num-2');
            
            if (op === 'bt') {
                input2.classList.remove('hidden');
                row.querySelector('.filter-num-1').placeholder = "من";
            } else {
                input2.classList.add('hidden');
                row.querySelector('.filter-num-1').placeholder = "القيمة";
            }
            applyMultiFilters();
        };

        // تطبيق الفلتر (المنطق الرئيسي)
        window.applyMultiFilters = function() {
            if (!landsData) return;

            // جمع المعايير
            const rows = filtersContainer.querySelectorAll('.filter-row');
            const criteria = [];

            rows.forEach(row => {
                const attr = row.querySelector('.filter-attr').value;
                if (!attr) return;

                // هل هو فلتر رقمي أم نصي؟
                const isNumeric = row.querySelector('.filter-op') !== null;

                if (isNumeric) {
                    const op = row.querySelector('.filter-op').value;
                    const val1 = parseFloat(row.querySelector('.filter-num-1').value);
                    const val2 = parseFloat(row.querySelector('.filter-num-2').value);
                    
                    if (!isNaN(val1)) {
                        criteria.push({ type: 'numeric', attr, op, val1, val2 });
                    }
                } else {
                    const val = row.querySelector('.filter-val').value;
                    if (val !== "") {
                        criteria.push({ type: 'text', attr, val });
                    }
                }
            });

            // تنفيذ التصفية
            const filteredFeatures = landsData.features.filter(feature => {
                return criteria.every(crit => {
                    const propVal = feature.properties[crit.attr];

                    if (crit.type === 'text') {
                        return String(propVal) === String(crit.val);
                    } 
                    else if (crit.type === 'numeric') {
                        const numVal = parseFloat(propVal);
                        if (isNaN(numVal)) return false; // تجاهل القيم غير الرقمية

                        if (crit.op === 'eq') return numVal === crit.val1;
                        if (crit.op === 'gt') return numVal > crit.val1;
                        if (crit.op === 'lt') return numVal < crit.val1;
                        if (crit.op === 'bt') return numVal >= crit.val1 && numVal <= (isNaN(crit.val2) ? crit.val1 : crit.val2);
                        return true;
                    }
                });
            });

            // رسم النتائج
            layers.lands.clearLayers();
            L.geoJSON({ type: "FeatureCollection", features: filteredFeatures }, {
                pointToLayer: function (feature, latlng) {
                    return L.circleMarker(latlng, {
                        radius: 6,
                        fillColor: "#2563eb",
                        color: "#fff",
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    });
                },
                onEachFeature: (feature, layer) => {
                     let content = `<div class="bg-blue-600 text-white p-3 font-bold text-sm">بيانات الأرض</div><div class="p-3 bg-white text-sm max-h-60 overflow-y-auto">`;
                    for (const [key, v] of Object.entries(feature.properties)) {
                        if(key === 'OBJECTID' || key === 'Shape_Length' || key === 'Shape_Area' || key === 'Shape') continue;
                        content += `<div class="flex justify-between py-1 border-b border-gray-100"><span class="text-gray-500">${key}</span><span class="text-gray-800 font-bold">${v}</span></div>`;
                    }
                    content += `</div>`;
                    layer.bindPopup(content);
                }
            }).addTo(layers.lands);

            updateCount(filteredFeatures.length);
        };

        // ==========================================
        // 5. وظائف مساعدة والعرض
        // ==========================================

        function renderLayers() {
            if(landsData) {
                applyMultiFilters(); 
                try {
                    const bounds = L.geoJSON(landsData).getBounds();
                    if (bounds.isValid()) map.fitBounds(bounds);
                } catch(e) {}
            }

            if(urbanData) {
                layers.urban.clearLayers();
                L.geoJSON(urbanData, { 
                    style: styles.urban,
                    pointToLayer: function (feature, latlng) {
                        return L.circleMarker(latlng, { radius: 5, fillColor: "#ea580c", color: "#fff", weight: 1, opacity: 1, fillOpacity: 0.8 });
                    }
                }).addTo(layers.urban);
            }
            if(devData) {
                layers.dev.clearLayers();
                L.geoJSON(devData, { 
                    style: styles.dev,
                    pointToLayer: function (feature, latlng) {
                        return L.circleMarker(latlng, { radius: 5, fillColor: "#16a34a", color: "#fff", weight: 1, opacity: 1, fillOpacity: 0.8 });
                    }
                }).addTo(layers.dev);
            }
        }

        window.toggleLayer = (layerName, isChecked) => {
            if (isChecked) map.addLayer(layers[layerName]);
            else map.removeLayer(layers[layerName]);
        };

        function updateCount(num) {
            document.getElementById('countBadge').innerText = num;
        }

        function showToast(msg, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toast-msg');
            toastMsg.innerText = msg;
            toast.style.display = 'flex';
            
            if(type === 'warning') toast.querySelector('i').className = "fa-solid fa-triangle-exclamation text-yellow-400";
            else if(type === 'success') toast.querySelector('i').className = "fa-solid fa-circle-check text-green-400";
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 5000);
        }

        init();

    </script>
</body>
</html>
