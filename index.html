<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المستكشف الجغرافي - القريات</title>
    
    <!-- مكتبات الخرائط والتصميم -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Cairo', sans-serif; }
        #map { height: 100%; width: 100%; z-index: 0; }
        
        /* شاشة التحميل */
        #loading-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.98);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            transition: opacity 0.5s;
        }

        /* تحسين مظهر التمرير */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .leaflet-popup-content-wrapper { 
            border-radius: 8px; 
            padding: 0;
            overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .leaflet-popup-content { margin: 0; width: 300px !important; }
        
        /* تنبيهات */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            padding: 10px 20px;
            border-radius: 50px;
            background: rgba(0,0,0,0.8);
            color: white;
            font-size: 0.9rem;
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translate(-50%, 20px); } to { opacity: 1; transform: translate(-50%, 0); } }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col md:flex-row overflow-hidden">

    <!-- شاشة التحميل -->
    <div id="loading-screen">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600 mb-4"></div>
        <h2 class="text-xl font-bold text-slate-700" id="loading-text">جاري الاتصال بقاعدة البيانات...</h2>
        <p class="text-sm text-slate-500 mt-2">يرجى الانتظار قليلاً</p>
    </div>

    <!-- رسالة تنبيه -->
    <div id="toast" class="toast flex items-center gap-2">
        <i class="fa-solid fa-circle-info text-yellow-400"></i>
        <span id="toast-msg"></span>
    </div>

    <!-- الشريط الجانبي -->
    <aside class="w-full md:w-96 bg-white shadow-2xl z-20 flex flex-col border-l border-gray-200">
        
        <!-- الترويسة -->
        <div class="bg-slate-800 text-white p-6 shadow-md">
            <div class="flex items-center gap-3 mb-2">
                <div class="bg-blue-600 p-2 rounded-lg"><i class="fa-solid fa-map-location-dot text-xl"></i></div>
                <div>
                    <h1 class="text-lg font-bold">بوابة البيانات المكانية</h1>
                    <p class="text-xs text-slate-400">نظام استعراض الأراضي - القريات</p>
                </div>
            </div>
        </div>

        <!-- المحتوى -->
        <div class="flex-1 overflow-y-auto p-4 space-y-6">

            <!-- رسالة خطأ بسيطة (تظهر فقط عند فشل الاتصال الحقيقي) -->
            <div id="error-msg" class="bg-red-50 p-4 rounded-xl border border-red-200 shadow-sm hidden">
                <h3 class="text-sm font-bold text-red-800 mb-1 flex items-center gap-2">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                    تنبيه النظام
                </h3>
                <p class="text-xs text-red-600">
                    تعذر الوصول لملفات البيانات. يرجى التحقق من رفع الملفات الصحيحة (lands.geojson) في المستودع.
                </p>
            </div>

            <!-- بطاقة الفلترة -->
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-5">
                <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-filter text-blue-600"></i>
                    تصفية الأراضي الحكومية
                </h3>

                <div class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-slate-500 block mb-1">تصنيف حسب</label>
                        <select id="filterAttribute" class="w-full bg-slate-50 border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 transition">
                            <option value="">جاري تحميل البيانات...</option>
                        </select>
                    </div>

                    <div>
                        <label class="text-xs font-bold text-slate-500 block mb-1">القيمة</label>
                        <select id="filterValue" disabled class="w-full bg-slate-50 border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 disabled:opacity-50 transition">
                            <option value="">الكل</option>
                        </select>
                    </div>

                    <div class="flex gap-2 pt-2">
                        <button id="applyBtn" class="flex-1 text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition shadow-lg shadow-blue-500/30 active:scale-95">تطبيق</button>
                        <button id="resetBtn" class="text-slate-700 bg-slate-100 hover:bg-slate-200 font-medium rounded-lg text-sm px-4 py-2.5 transition active:scale-95" title="إعادة تعيين"><i class="fa-solid fa-rotate-right"></i></button>
                    </div>
                </div>

                <div class="mt-4 pt-3 border-t border-slate-100 flex justify-between items-center text-xs">
                    <span class="text-slate-500">النتائج المعروضة:</span>
                    <span id="countBadge" class="bg-blue-100 text-blue-800 font-bold px-2.5 py-0.5 rounded border border-blue-200">0 أرض</span>
                </div>
            </div>

            <!-- التحكم بالطبقات -->
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-4">
                <h3 class="font-bold text-slate-700 mb-3 text-sm">الطبقات المتاحة</h3>
                <div class="space-y-2">
                    <!-- طبقة الأراضي -->
                    <label class="flex items-center justify-between p-3 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100 transition border border-transparent hover:border-slate-300 group">
                        <div class="flex items-center gap-3">
                            <input type="checkbox" checked onchange="toggleLayer('lands', this.checked)" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                            <span class="text-sm font-medium text-slate-700 group-hover:text-blue-700">الأراضي الحكومية (نقاط)</span>
                        </div>
                        <span class="w-3 h-3 rounded-full bg-blue-600 ring-2 ring-blue-200"></span>
                    </label>

                    <!-- طبقة النطاق العمراني -->
                    <label class="flex items-center justify-between p-3 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100 transition border border-transparent hover:border-slate-300 group">
                        <div class="flex items-center gap-3">
                            <input type="checkbox" checked onchange="toggleLayer('urban', this.checked)" class="w-4 h-4 text-orange-500 rounded focus:ring-orange-500">
                            <span class="text-sm font-medium text-slate-700 group-hover:text-orange-700">النطاق العمراني</span>
                        </div>
                        <span class="w-3 h-3 border-2 border-dashed border-orange-500"></span>
                    </label>

                    <!-- طبقة التنمية -->
                    <label class="flex items-center justify-between p-3 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100 transition border border-transparent hover:border-slate-300 group">
                        <div class="flex items-center gap-3">
                            <input type="checkbox" checked onchange="toggleLayer('dev', this.checked)" class="w-4 h-4 text-green-600 rounded focus:ring-green-500">
                            <span class="text-sm font-medium text-slate-700 group-hover:text-green-700">حدود التنمية</span>
                        </div>
                        <span class="w-3 h-3 border-2 border-green-600"></span>
                    </label>
                </div>
            </div>
            
             <!-- حالة البيانات -->
             <div id="data-status" class="p-3 bg-gray-100 rounded text-xs text-gray-500 text-center">
                جاري الاتصال...
            </div>
        </div>

        <div class="p-4 bg-slate-50 text-center text-[10px] text-slate-400 border-t">
            Saud Consult GIS Team &copy; 2024
        </div>
    </aside>

    <!-- الخريطة -->
    <main class="flex-1 relative">
        <div id="map"></div>
        
        <!-- زر الموقع الحالي -->
        <button onclick="map.locate({setView: true, maxZoom: 16})" class="absolute bottom-6 right-6 z-[1000] bg-white p-3 rounded-full shadow-lg text-slate-600 hover:text-blue-600 transition" title="موقعي">
            <i class="fa-solid fa-crosshairs text-lg"></i>
        </button>
    </main>

    <script>
        // ==========================================
        // 1. إعدادات البيانات (القريات)
        // ==========================================
        const FILES = {
            lands: 'lands.geojson',   
            urban: 'urban.geojson',   
            dev: 'dev.geojson'        
        };

        // المتغيرات لحفظ البيانات عند تحميلها
        let landsData = null; 
        let urbanData = null;
        let devData = null;

        // ==========================================
        // 2. إعداد الخريطة
        // ==========================================
        
        // تعديل الزووم على القريات (31.33, 37.34)
        const map = L.map('map', {zoomControl: false}).setView([31.33, 37.34], 12);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            maxZoom: 19
        }).addTo(map);

        const layers = {
            lands: new L.LayerGroup().addTo(map),
            urban: new L.LayerGroup().addTo(map),
            dev: new L.LayerGroup().addTo(map)
        };

        const styles = {
            urban: { color: "#ea580c", weight: 2, dashArray: '8, 8', fill: false },
            dev:   { color: "#16a34a", weight: 3, fill: false }
        };

        // ==========================================
        // 3. المنطق الأساسي: تحميل البيانات
        // ==========================================

        async function init() {
            try {
                // محاولة جلب ملف الأراضي
                const response = await fetch(FILES.lands);
                if (!response.ok) {
                    throw new Error(`HTTP Error: ${response.status}`);
                }
                landsData = await response.json();
                
                // نجاح التحميل (بيئة GitHub)
                showToast(`تم تحميل البيانات بنجاح`, "success");
                document.getElementById('data-status').innerHTML = '<span class="text-green-600 font-bold"><i class="fa-solid fa-check"></i> متصل بالخادم (Live)</span>';
                document.getElementById('error-msg').classList.add('hidden');

                // جلب باقي الملفات بشكل صامت
                try { const uRes = await fetch(FILES.urban); if(uRes.ok) urbanData = await uRes.json(); } catch(e) {}
                try { const dRes = await fetch(FILES.dev); if(dRes.ok) devData = await dRes.json(); } catch(e) {}

            } catch (error) {
                // التعامل الذكي مع الأخطاء (للتمييز بين بيئة المعاينة والسيرفر الحقيقي)
                
                if (error.message && (error.message.includes("Failed to parse URL") || error.message.includes("NetworkError"))) {
                    // هذا الخطأ يظهر فقط في بيئة المعاينة أو التشغيل المحلي بدون سيرفر
                    console.warn("بيئة المعاينة: لا يمكن قراءة الملفات النسبية. ستعمل عند الرفع على GitHub.");
                    document.getElementById('data-status').innerHTML = '<span class="text-orange-500 font-bold"><i class="fa-solid fa-server"></i> بانتظار السيرفر (GitHub)</span>';
                    showToast(`تنبيه: البيانات ستظهر عند الرفع على GitHub`, "info");
                } else {
                    // خطأ حقيقي (مثل الملف غير موجود 404)
                    console.error("فشل التحميل من المستودع:", error);
                    showToast(`خطأ في الاتصال بقاعدة البيانات`, "warning");
                    document.getElementById('data-status').innerHTML = '<span class="text-red-500 font-bold"><i class="fa-solid fa-xmark"></i> فشل الاتصال</span>';
                    document.getElementById('error-msg').classList.remove('hidden');
                }
                
            } finally {
                renderLayers();
                populateAttributes();
                if(landsData) updateCount(landsData.features.length);
                
                document.getElementById('loading-screen').style.opacity = '0';
                setTimeout(() => { document.getElementById('loading-screen').style.display = 'none'; }, 500);
            }
        }

        // ==========================================
        // 4. وظائف العرض والتحكم
        // ==========================================

        function renderLayers() {
            if(landsData) {
                layers.lands.clearLayers();
                
                L.geoJSON(landsData, {
                    pointToLayer: function (feature, latlng) {
                        return L.circleMarker(latlng, {
                            radius: 6,
                            fillColor: "#2563eb",
                            color: "#fff",
                            weight: 1,
                            opacity: 1,
                            fillOpacity: 0.8
                        });
                    },
                    onEachFeature: (feature, layer) => {
                        let content = `
                            <div class="bg-blue-600 text-white p-3 font-bold text-sm flex justify-between items-center">
                                <span>البيانات الوصفية</span>
                            </div>
                            <div class="p-3 bg-white text-sm max-h-60 overflow-y-auto">
                        `;
                        for (const [key, val] of Object.entries(feature.properties)) {
                            if(key === 'OBJECTID' || key === 'Shape_Length' || key === 'Shape_Area') continue;
                            content += `
                                <div class="flex justify-between py-1.5 border-b border-gray-100 last:border-0 hover:bg-gray-50">
                                    <span class="text-gray-500 font-medium ml-2">${key}</span>
                                    <span class="text-gray-800 font-bold text-left" dir="ltr">${val}</span>
                                </div>
                            `;
                        }
                        content += `</div>`;
                        layer.bindPopup(content);
                    }
                }).addTo(layers.lands);
                
                try {
                    const bounds = L.geoJSON(landsData).getBounds();
                    if (bounds.isValid()) map.fitBounds(bounds);
                } catch(e) {}
            }

            if(urbanData) {
                layers.urban.clearLayers();
                L.geoJSON(urbanData, { style: styles.urban }).addTo(layers.urban);
            }
            if(devData) {
                layers.dev.clearLayers();
                L.geoJSON(devData, { style: styles.dev }).addTo(layers.dev);
            }
        }

        window.toggleLayer = (layerName, isChecked) => {
            if (isChecked) map.addLayer(layers[layerName]);
            else map.removeLayer(layers[layerName]);
        };

        function populateAttributes() {
            const attrSelect = document.getElementById('filterAttribute');
            attrSelect.innerHTML = '<option value="">-- اختر الحقل للتصنيف --</option>';

            if (!landsData || !landsData.features || landsData.features.length === 0) return;

            const keys = Object.keys(landsData.features[0].properties);
            
            keys.sort().forEach(key => {
                 if(key !== 'OBJECTID' && key !== 'Shape' && key !== 'GlobalID') {
                    const opt = document.createElement('option');
                    opt.value = key;
                    opt.innerText = key;
                    attrSelect.appendChild(opt);
                 }
            });
        }

        document.getElementById('filterAttribute').addEventListener('change', (e) => {
            const attr = e.target.value;
            const valSelect = document.getElementById('filterValue');
            valSelect.innerHTML = '<option value="">-- الكل --</option>';
            
            if (!attr) {
                valSelect.disabled = true;
                return;
            }
            valSelect.disabled = false;

            const uniqueValues = new Set();
            landsData.features.forEach(f => {
                if (f.properties[attr] !== undefined && f.properties[attr] !== null) {
                    uniqueValues.add(f.properties[attr]);
                }
            });
            
            const sortedValues = Array.from(uniqueValues).sort();

            sortedValues.forEach(val => {
                const opt = document.createElement('option');
                opt.value = val;
                opt.innerText = val;
                valSelect.appendChild(opt);
            });
        });

        document.getElementById('applyBtn').addEventListener('click', () => {
            const attr = document.getElementById('filterAttribute').value;
            const val = document.getElementById('filterValue').value;

            if(!landsData) return;

            layers.lands.clearLayers();

            const filtered = landsData.features.filter(f => {
                if (!attr) return true;
                if (val === "") return true;
                return String(f.properties[attr]) === String(val); 
            });

            L.geoJSON({ type: "FeatureCollection", features: filtered }, {
                pointToLayer: function (feature, latlng) {
                    return L.circleMarker(latlng, {
                        radius: 6,
                        fillColor: "#2563eb",
                        color: "#fff",
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    });
                },
                onEachFeature: (feature, layer) => {
                     let content = `<div class="bg-blue-600 text-white p-3 font-bold text-sm">نتيجة البحث</div><div class="p-3 bg-white text-sm max-h-60 overflow-y-auto">`;
                    for (const [key, v] of Object.entries(feature.properties)) {
                        if(key === 'OBJECTID' || key === 'Shape_Length' || key === 'Shape_Area') continue;
                        content += `<div class="flex justify-between py-1 border-b border-gray-100"><span class="text-gray-500">${key}</span><span class="text-gray-800 font-bold">${v}</span></div>`;
                    }
                    content += `</div>`;
                    layer.bindPopup(content);
                }
            }).addTo(layers.lands);

            updateCount(filtered.length);
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            document.getElementById('filterAttribute').value = "";
            document.getElementById('filterValue').innerHTML = '<option value="">الكل</option>';
            document.getElementById('filterValue').disabled = true;
            
            layers.lands.clearLayers();
            renderLayers(); 
            updateCount(landsData.features.length);
        });

        function updateCount(num) {
            document.getElementById('countBadge').innerText = num + " أرض";
        }

        function showToast(msg, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toast-msg');
            toastMsg.innerText = msg;
            toast.style.display = 'flex';
            
            if(type === 'warning') toast.querySelector('i').className = "fa-solid fa-triangle-exclamation text-yellow-400";
            else if(type === 'success') toast.querySelector('i').className = "fa-solid fa-circle-check text-green-400";
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 5000);
        }

        // بدء التشغيل
        init();

    </script>
</body>
</html>
